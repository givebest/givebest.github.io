"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[9630],{9613:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>h});var a=t(9496);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var i=a.createContext({}),p=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(i.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,i=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(t),m=o,h=c["".concat(i,".").concat(m)]||c[m]||d[m]||r;return t?a.createElement(h,s(s({ref:n},u),{},{components:t})):a.createElement(h,s({ref:n},u))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,s=new Array(r);s[0]=m;var l={};for(var i in n)hasOwnProperty.call(n,i)&&(l[i]=n[i]);l.originalType=e,l[c]="string"==typeof e?e:o,s[1]=l;for(var p=2;p<r;p++)s[p]=t[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},7950:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=t(1163),o=(t(9496),t(9613));const r={slug:"other/2018/10/27/upyun-upload-delete-node.js.html",title:"\u53c8\u62cd\u4e91 Node.js \u5b9e\u73b0\u6587\u4ef6\u4e0a\u4f20\u3001\u5220\u9664",tags:["node.js"],date:"2018-10-27 11:14:35 +0800",authors:"givebest"},s="\u53c8\u62cd\u4e91 Node.js \u5b9e\u73b0\u6587\u4ef6\u4e0a\u4f20\u3001\u5220\u9664",l={permalink:"/other/2018/10/27/upyun-upload-delete-node.js.html",source:"@site/blog/2018-10-27-upyun-upload-delete-node.js.mdx",title:"\u53c8\u62cd\u4e91 Node.js \u5b9e\u73b0\u6587\u4ef6\u4e0a\u4f20\u3001\u5220\u9664",description:"Node.js \u670d\u52a1\u7aef",date:"2018-10-27T11:14:35.000Z",formattedDate:"2018\u5e7410\u670827\u65e5",tags:[{label:"node.js",permalink:"/tags/node-js"}],readingTime:3.505,hasTruncateMarker:!0,authors:[{name:"givebest",title:"Front End Engineer",url:"https://github.com/givebest",imageURL:"https://github.com/givebest.png",key:"givebest"}],frontMatter:{slug:"other/2018/10/27/upyun-upload-delete-node.js.html",title:"\u53c8\u62cd\u4e91 Node.js \u5b9e\u73b0\u6587\u4ef6\u4e0a\u4f20\u3001\u5220\u9664",tags:["node.js"],date:"2018-10-27 11:14:35 +0800",authors:"givebest"},prevItem:{title:"2019\u5e74\u8f6c\u8f6c\u4f18\u54c1\u81ea\u8425\u4e8c\u624b iPhone \u8d2d\u4e70\u7ecf\u5386",permalink:"/other/2019/03/09/2019-zhuanzhuan-youpin-goumai.html"},nextItem:{title:"Docz \u7528 MDX \u5199 React UI \u7ec4\u4ef6\u6587\u6863",permalink:"/other/2018/09/15/react-ui-component-docz-mdx.html"}},i={authorsImageUrls:[void 0]},p=[{value:"Node.js \u670d\u52a1\u7aef",id:"nodejs-\u670d\u52a1\u7aef",level:2},{value:"\u4f7f\u7528 Node.js + Express.js \u5b9e\u73b0 \u670d\u52a1\u7aef",id:"\u4f7f\u7528-nodejs--expressjs-\u5b9e\u73b0-\u670d\u52a1\u7aef",level:3},{value:"\u51c6\u5907 Base64\u3001HMAC-SHA1\u3001MD5 \u5b9e\u73b0\u7b7e\u540d\u8ba4\u8bc1",id:"\u51c6\u5907-base64hmac-sha1md5-\u5b9e\u73b0\u7b7e\u540d\u8ba4\u8bc1",level:3},{value:"\u4e0a\u4f20\u3001\u5220\u9664\u63a5\u53e3",id:"\u4e0a\u4f20\u5220\u9664\u63a5\u53e3",level:3},{value:"\u8de8\u57df\u63a5\u53e3\u8c03\u7528",id:"\u8de8\u57df\u63a5\u53e3\u8c03\u7528",level:3},{value:"\u524d\u7aef",id:"\u524d\u7aef",level:2},{value:"\u5f15\u5165 Bootstrap.css",id:"\u5f15\u5165-bootstrapcss",level:3},{value:"\u5f15\u5165 Vue.js\u3001Axios",id:"\u5f15\u5165-vuejsaxios",level:3},{value:"JS",id:"js",level:3},{value:"\u9879\u76ee\u6e90\u7801",id:"\u9879\u76ee\u6e90\u7801",level:2},{value:"\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904\uff1a https://blog.givebest.cn/other/2018/10/27/upyun-upload-delete-node.js.html",id:"\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904-httpsbloggivebestcnother20181027upyun-upload-delete-nodejshtml",level:5}],u={toc:p},c="wrapper";function d(e){let{components:n,...t}=e;return(0,o.kt)(c,(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"nodejs-\u670d\u52a1\u7aef"},"Node.js \u670d\u52a1\u7aef"),(0,o.kt)("h3",{id:"\u4f7f\u7528-nodejs--expressjs-\u5b9e\u73b0-\u670d\u52a1\u7aef"},"\u4f7f\u7528 Node.js + Express.js \u5b9e\u73b0 \u670d\u52a1\u7aef"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const express = require("express");\nconst app = express();\nconst axios = require("axios");\n\napp.set("port", process.env.PORT || 8082);\n\n// \u9759\u6001\u8d44\u6e90\u76ee\u5f55\uff0c\u8fd9\u91cc\u653e\u5728\u4e86\u6839\u76ee\u5f55\uff0c\u751f\u4ea7\u73af\u5883\u4e0d\u5141\u8bb8\u8fd9\u6837\napp.use(express.static(__dirname));\n\n// \u542f\u52a8\u4e00\u4e2a\u7aef\u53e3\u4e3a 8082 \u7684\u670d\u52a1\u5668\napp.listen(app.get("port"), () => {\n  console.log("http://localhost:" + app.get("port"));\n});\n')),(0,o.kt)("h3",{id:"\u51c6\u5907-base64hmac-sha1md5-\u5b9e\u73b0\u7b7e\u540d\u8ba4\u8bc1"},"\u51c6\u5907 Base64\u3001HMAC-SHA1\u3001MD5 \u5b9e\u73b0\u7b7e\u540d\u8ba4\u8bc1"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8be6\u89c1\uff1a",(0,o.kt)("a",{parentName:"p",href:"http://docs.upyun.com/api/authorization/#_5"},"http://docs.upyun.com/api/authorization/#_5"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const crypto = require("crypto");\n\n// MD5\nfunction MD5(value) {\n  return crypto.createHash("md5").update(value).digest("hex");\n}\n\n// Base64\nfunction base64(value) {\n  return Buffer.from(value).toString("base64");\n}\n\n// hmacsha1\nfunction hmacsha1(secret, value) {\n  return crypto\n    .createHmac("sha1", secret)\n    .update(value, "utf-8")\n    .digest()\n    .toString("base64");\n}\n')),(0,o.kt)("h3",{id:"\u4e0a\u4f20\u5220\u9664\u63a5\u53e3"},"\u4e0a\u4f20\u3001\u5220\u9664\u63a5\u53e3"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const date = new Date().toGMTString();\nconst bucketname = ""; // \u7a7a\u95f4\u540d\nconst key = ""; // \u64cd\u4f5c\u5458\nconst secret = ""; // \u5bc6\u7801\nconst upyunUrl = "http://v0.api.upyun.com/";\n\n// Upload\napp.get("/api/token/upload", (req, res) => {\n  let fileName = (Math.random() * 100000000) >>> 0;\n  let expiration = ((Date.now() / 1000) >>> 0) + 30 * 60; // \u8bf7\u6c42\u7684\u8fc7\u671f\u65f6\u95f4\uff0cUNIX UTC \u65f6\u95f4\u6233\uff0c\u5355\u4f4d\u79d2\u3002\u5efa\u8bae\u8bbe\u4e3a 30 \u5206\u949f http://docs.upyun.com/api/form_api/\n  let method = "POST";\n\n  let policy = base64(\n    JSON.stringify({\n      bucket: bucketname,\n      // "save-key": "/" + fileName + "{.suffix}",\n      "save-key": "/{filename}{.suffix}",\n      expiration: expiration,\n    })\n  );\n\n  let authorization =\n    "UPYUN " +\n    key +\n    ":" +\n    hmacsha1(MD5(secret), method + "&/" + bucketname + "&" + policy);\n\n  res.json({\n    msg: "OK",\n    code: 200,\n    data: {\n      authorization: authorization,\n      policy: policy,\n    },\n  });\n});\n\n// Delete\napp.get("/api/token/del", (req, res) => {\n  let item = req.query.item;\n  let method = "DELETE";\n  let authorization =\n    "UPYUN " +\n    key +\n    ":" +\n    hmacsha1(MD5(secret), method + "&/" + bucketname + item + "&" + date);\n\n  axios({\n    url: upyunUrl + bucketname + item,\n    method: "DELETE",\n    headers: {\n      Authorization: authorization,\n      Date: date,\n    },\n  })\n    .then((response) => {\n      res.json({\n        msg: "OK",\n        code: 200,\n        data: {},\n      });\n    })\n    .catch((err) => {\n      console.log("err", err);\n    });\n});\n')),(0,o.kt)("h3",{id:"\u8de8\u57df\u63a5\u53e3\u8c03\u7528"},"\u8de8\u57df\u63a5\u53e3\u8c03\u7528"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const cors = require("cors");\n\n// CORS @see https://github.com/expressjs/cors\napp.use(cors());\n')),(0,o.kt)("h2",{id:"\u524d\u7aef"},"\u524d\u7aef"),(0,o.kt)("p",null,"\u524d\u7aef\u4f7f\u7528 Vue.js \u5b9e\u73b0"),(0,o.kt)("h3",{id:"\u5f15\u5165-bootstrapcss"},"\u5f15\u5165 Bootstrap.css"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},'<link\n  rel="stylesheet"\n  type="text/css"\n  href="https://unpkg.com/bootstrap@4.1.3/dist/css/bootstrap.css"\n/>\n<script src="https://unpkg.com/axios/dist/axios.min.js"><\/script>\n\x3c!-- HTML --\x3e\n<div id="app">\n  <div class="card" style="margin: 50px auto; width: 300px;">\n    <div class="card-body">\n      <h5 class="card-title">UPYun Upload & Delete</h5>\n      <div class="card-text">\n        <div class="form-group">\n          <label for="file">Upload</label>\n          <input\n            type="file"\n            id="file"\n            class="form-control-file"\n            @change="onChange"\n          />\n          <div class="form-text text-muted">\n            <ul>\n              <li v-for="(item, index) in files">\n                {{item}}\n                <a href="javascript:;" @click="onDel(item, index)">Del</a>\n              </li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n')),(0,o.kt)("h3",{id:"\u5f15\u5165-vuejsaxios"},"\u5f15\u5165 Vue.js\u3001Axios"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},'<script src="https://unpkg.com/vue@2.5.17/dist/vue.js"><\/script>\n<script src="https://unpkg.com/axios/dist/axios.min.js"><\/script>\n')),(0,o.kt)("h3",{id:"js"},"JS"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const upUrl = "http://v0.api.upyun.com/"; // +\u7a7a\u95f4\u540d\uff0c\u5982\uff1ahttp://v0.api.upyun.com/yun-temp\nconst baseApi = "http://localhost:8082/api/";\nlet uploadInput;\n\nlet app = new Vue({\n  el: "#app",\n  data: {\n    files: [],\n  },\n  methods: {\n    onChange: function () {\n      getToken((token) => {\n        let formData = new FormData();\n        formData.append("file", uploadInput.files[0]);\n        formData.append("policy", token.policy);\n        formData.append("authorization", token.authorization);\n\n        axios({\n          method: "POST",\n          url: upUrl,\n          data: formData,\n        })\n          .then((res) => {\n            res = res || {};\n\n            if (res.status !== 200) {\n              console.log("error");\n              return;\n            }\n\n            let data = res.data || {};\n            this.files.push(data.url);\n            alert("Success");\n          })\n          .catch((err) => {\n            console.log(err);\n          });\n      });\n    },\n    onDel: function (item, index) {\n      this.files.splice(index, 1);\n      axios\n        .request({\n          url: baseApi + "token/del",\n          method: "GET",\n          params: {\n            item: encodeURI(item),\n          },\n        })\n        .then((res) => {\n          alert("Deleted.");\n        })\n        .catch((err) => {\n          console.log(err);\n        });\n    },\n  },\n  mounted() {\n    uploadInput = $("file");\n  },\n});\n\n// DOM \u83b7\u53d6\u5143\u7d20\nfunction $(el) {\n  return document.getElementById(el);\n}\n\n// \u83b7\u53d6 token\nfunction getToken(fn) {\n  let token = window.localStorage.getItem("token");\n  token = JSON.parse(token) || {};\n  let nowTime = Date.now();\n\n  if (nowTime < token.expired && token.authorization && token.policy) {\n    fn(token);\n    return;\n  }\n\n  axios({\n    method: "get",\n    url: baseApi + "token/upload",\n  }).then((res) => {\n    let data = res.data || {};\n    data = data.data || {};\n    const authorization = data.authorization;\n    const policy = data.policy;\n    const expired = ((Date.now() / 1000) >>> 0) + 30 * 60;\n\n    token = {\n      authorization,\n      policy,\n      expired,\n    };\n\n    fn(token);\n    window.localStorage.setItem("token", JSON.stringify(token));\n  });\n}\n')),(0,o.kt)("h2",{id:"\u9879\u76ee\u6e90\u7801"},"\u9879\u76ee\u6e90\u7801"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://github.com/givebest/UPyun-upload-delete-node.js"},"https://github.com/givebest/UPyun-upload-delete-node.js"))),(0,o.kt)("h5",{id:"\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904-httpsbloggivebestcnother20181027upyun-upload-delete-nodejshtml"},"\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904\uff1a ",(0,o.kt)("a",{parentName:"h5",href:"https://blog.givebest.cn/other/2018/10/27/upyun-upload-delete-node.js.html"},"https://blog.givebest.cn/other/2018/10/27/upyun-upload-delete-node.js.html")))}d.isMDXComponent=!0}}]);