"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[9498],{9613:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var s=n(9496);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,s,a=function(e,t){if(null==e)return{};var n,s,a={},r=Object.keys(e);for(s=0;s<r.length;s++)n=r[s],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(s=0;s<r.length;s++)n=r[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var m=s.createContext({}),c=function(e){var t=s.useContext(m),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return s.createElement(m.Provider,{value:t},e.children)},l="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},u=s.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,m=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),l=c(n),u=a,d=l["".concat(m,".").concat(u)]||l[u]||g[u]||r;return n?s.createElement(d,o(o({ref:t},p),{},{components:n})):s.createElement(d,o({ref:t},p))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=u;var i={};for(var m in t)hasOwnProperty.call(t,m)&&(i[m]=t[m]);i.originalType=e,i[l]="string"==typeof e?e:a,o[1]=i;for(var c=2;c<r;c++)o[c]=n[c];return s.createElement.apply(null,o)}return s.createElement.apply(null,n)}u.displayName="MDXCreateElement"},6110:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>m,contentTitle:()=>o,default:()=>g,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var s=n(1163),a=(n(9496),n(9613));const r={slug:"javascript/2024/06/14/web-page-using-postmessage-to-communicate-with-chrome-extension.html",title:"Web \u7f51\u9875\u4f7f\u7528 postmessage \u4e0e Chrome \u6269\u5c55\u901a\u8baf\u652f\u6301 promise",tags:["postmessage","chrome extension"],date:"2024-06-14 18:32:01 +0800",authors:"givebest"},o=void 0,i={permalink:"/javascript/2024/06/14/web-page-using-postmessage-to-communicate-with-chrome-extension.html",source:"@site/blog/javascript/2024-06-14-web-page-using-postmessage-to-communicate-with-chrome-extension.mdx",title:"Web \u7f51\u9875\u4f7f\u7528 postmessage \u4e0e Chrome \u6269\u5c55\u901a\u8baf\u652f\u6301 promise",description:"\u6d4f\u89c8\u5668\u7f51\u9875\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u4f7f\u7528 postmessage \u4e0e Chrome \u6269\u5c55\u901a\u8baf\uff0c\u4f46\u662f postmessage \u53ea\u80fd\u4f20\u9012\u6d88\u606f\uff0c\u4e0d\u80fd\u4f20\u9012 promise\uff0c\u5982\u679c\u9047\u5230\u7f51\u9875\u9700\u8981\u7b49\u5f85 Chrome \u6269\u5c55\u8fd4\u56de\u7684 promise\uff0c\u5904\u7406\u8d77\u6765\u5c31\u6bd4\u8f83\u9ebb\u70e6\u4e86\u3002",date:"2024-06-14T18:32:01.000Z",formattedDate:"2024\u5e746\u670814\u65e5",tags:[{label:"postmessage",permalink:"/tags/postmessage"},{label:"chrome extension",permalink:"/tags/chrome-extension"}],readingTime:2.105,hasTruncateMarker:!0,authors:[{name:"givebest",title:"Front End Engineer",url:"https://github.com/givebest",imageURL:"https://github.com/givebest.png",key:"givebest"}],frontMatter:{slug:"javascript/2024/06/14/web-page-using-postmessage-to-communicate-with-chrome-extension.html",title:"Web \u7f51\u9875\u4f7f\u7528 postmessage \u4e0e Chrome \u6269\u5c55\u901a\u8baf\u652f\u6301 promise",tags:["postmessage","chrome extension"],date:"2024-06-14 18:32:01 +0800",authors:"givebest"},nextItem:{title:"Chrome \u6269\u5c55\u8f6c Safari \u6269\u5c55\u5e38\u89c1\u95ee\u9898",permalink:"/other/2023/03/17/chrome-extension-converter-safari-extension.html"}},m={authorsImageUrls:[void 0]},c=[{value:"\u7f51\u9875\u53d1\u9001\u5e76\u63a5\u6536 <code>promise</code> \u6d88\u606f",id:"\u7f51\u9875\u53d1\u9001\u5e76\u63a5\u6536-promise-\u6d88\u606f",level:2},{value:"Chrome \u6269\u5c55\u63a5\u6536\u5e76\u53d1\u9001\u6d88\u606f",id:"chrome-\u6269\u5c55\u63a5\u6536\u5e76\u53d1\u9001\u6d88\u606f",level:2},{value:"content-script.js",id:"content-scriptjs",level:3},{value:"background.js",id:"backgroundjs",level:3},{value:"\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904\uff1a https://blog.givebest.cn/javascript/2024/06/14/web-page-using-postmessage-to-communicate-with-chrome-extension.html",id:"\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904-httpsbloggivebestcnjavascript20240614web-page-using-postmessage-to-communicate-with-chrome-extensionhtml",level:4}],p={toc:c},l="wrapper";function g(e){let{components:t,...n}=e;return(0,a.kt)(l,(0,s.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u6d4f\u89c8\u5668\u7f51\u9875\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"postmessage")," \u4e0e Chrome \u6269\u5c55\u901a\u8baf\uff0c\u4f46\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"postmessage")," \u53ea\u80fd\u4f20\u9012\u6d88\u606f\uff0c\u4e0d\u80fd\u4f20\u9012 promise\uff0c\u5982\u679c\u9047\u5230\u7f51\u9875\u9700\u8981\u7b49\u5f85 Chrome \u6269\u5c55\u8fd4\u56de\u7684 promise\uff0c\u5904\u7406\u8d77\u6765\u5c31\u6bd4\u8f83\u9ebb\u70e6\u4e86\u3002"),(0,a.kt)("p",null,"\u73b0\u5728\u53ef\u4ee5\u901a\u8fc7\u5c01\u88c5 ",(0,a.kt)("inlineCode",{parentName:"p"},"postmessage")," \u53d1\u9001\u6d88\u606f \u548c \u76d1\u542c ",(0,a.kt)("inlineCode",{parentName:"p"},"message")," \u63a5\u6536\u6d88\u606f\uff0c\u7136\u540e\u76f4\u63a5\u8fd4\u56de ",(0,a.kt)("inlineCode",{parentName:"p"},"promise"),"\uff0c\u8fd9\u4e0b\u5c31\u65b9\u4fbf\u591a\u4e86\u3002"),(0,a.kt)("h2",{id:"\u7f51\u9875\u53d1\u9001\u5e76\u63a5\u6536-promise-\u6d88\u606f"},"\u7f51\u9875\u53d1\u9001\u5e76\u63a5\u6536 ",(0,a.kt)("inlineCode",{parentName:"h2"},"promise")," \u6d88\u606f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-html"},'<html lang="en">\n  <head>\n    <meta charset="UTF-8" />\n    <title>test chrome extension</title>\n  </head>\n\n  <body>\n    <div id="btns">\n      <button class="install">\u6d4b\u8bd5\u53d1\u9001\u5e76\u63a5\u6536\u6d88\u606f</button>\n    </div>\n\n    <script>\n      async function waitForPostMessage({\n        timeout = 5000,\n        type,\n        data = {},\n        lang,\n      }) {\n        const returnType = `RETURN_${type}`;\n        let timeoutId = null;\n\n        window.postMessage({\n          type: type,\n          data: { ...data, timeout, lang },\n        });\n\n        const timeoutPromise = new Promise((_, reject) => {\n          setTimeout(() => {\n            reject(new Error("timeout"));\n          }, timeout);\n        });\n\n        const responsePromise = new Promise((resolve, reject) => {\n          function handleMessage(event) {\n            timeoutId = setTimeout(() => {\n              console.log("removeEventListener");\n              window.removeEventListener("message", handleMessage);\n            }, timeout);\n\n            const messageData = event?.data;\n            console.log("\ud83d\ude80 ~ handleMessage ~ messageData:", messageData);\n\n            if (messageData?.type !== returnType) {\n              return;\n            }\n\n            if (messageData && messageData.type === returnType) {\n              resolve(messageData);\n            } else {\n              reject(new Error("No data received in message"));\n            }\n\n            clearTimeout(timeoutId);\n            window.removeEventListener("message", handleMessage);\n          }\n\n          window.addEventListener("message", handleMessage);\n        });\n\n        return await Promise.race([responsePromise, timeoutPromise]);\n      }\n\n      document\n        .querySelector("#btns")\n        .addEventListener("click", async (event) => {\n          // \u68c0\u6d4b\u5b89\u88c5\u53caGoogle \u53ef\u7528\u6027\n          if (event.target.matches(".install")) {\n            waitForPostMessage({\n              type: "GLARITY_PING_URL",\n              timeout: 2000,\n            })\n              .then((data) => {\n                console.log("Received message data:", data?.data);\n              })\n              .catch((error) => {\n                console.error("Failed to receive message:", error);\n              });\n          }\n        });\n    <\/script>\n  </body>\n</html>\n')),(0,a.kt)("h2",{id:"chrome-\u6269\u5c55\u63a5\u6536\u5e76\u53d1\u9001\u6d88\u606f"},"Chrome \u6269\u5c55\u63a5\u6536\u5e76\u53d1\u9001\u6d88\u606f"),(0,a.kt)("h3",{id:"content-scriptjs"},"content-script.js"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'// content-script.js\nwindow.addEventListener("message", async (message) => {\n  const messageData = message.data || {};\n\n  const { type, data = {} } = messageData;\n\n  switch (type) {\n    case "GLARITY_PING_URL": {\n      const res = await Browser.runtime.sendMessage({\n        type: "PING_URL",\n        data: data,\n      });\n\n      window.postMessage({ type: "RETURN_GLARITY_PING_URL", data: res });\n\n      break;\n    }\n\n    default:\n      break;\n  }\n});\n')),(0,a.kt)("h3",{id:"backgroundjs"},"background.js"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'// background.js\nchrome.runtime.onMessage.addListener((request, sender) => {\n  if (request.type === "PING_URL") {\n    const { url = "https://google.com/", timeout } = request.data || {};\n\n    return fetch(url)\n      .then((res) => {\n        return { ok: res?.ok };\n      })\n      .catch(() => {\n        return { ok: false };\n      });\n  }\n});\n')),(0,a.kt)("h4",{id:"\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904-httpsbloggivebestcnjavascript20240614web-page-using-postmessage-to-communicate-with-chrome-extensionhtml"},"\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904\uff1a ",(0,a.kt)("a",{parentName:"h4",href:"https://blog.givebest.cn/javascript/2024/06/14/web-page-using-postmessage-to-communicate-with-chrome-extension.html"},"https://blog.givebest.cn/javascript/2024/06/14/web-page-using-postmessage-to-communicate-with-chrome-extension.html")))}g.isMDXComponent=!0}}]);